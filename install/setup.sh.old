#!/bin/bash
# FilamentBox Configuration Setup Script
# Interactively configures environment variables and creates/updates .env file

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory and installation root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_ROOT="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$INSTALL_ROOT/.env"

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}FilamentBox Configuration Setup${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Function to read existing .env value
get_env_value() {
    local key="$1"
    local default="$2"
    
    if [ -f "$ENV_FILE" ]; then
        # Extract value from .env file, handling comments and empty lines
        local value=$(grep "^${key}=" "$ENV_FILE" 2>/dev/null | cut -d'=' -f2- | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")
        if [ -n "$value" ]; then
            echo "$value"
            return
        fi
    fi
    echo "$default"
}

# Check if .env already exists
ENV_EXISTS=false
if [ -f "$ENV_FILE" ]; then
    ENV_EXISTS=true
    echo -e "${GREEN}Existing .env file found. Current values will be shown as defaults.${NC}"
    echo -e "${GREEN}Press Enter to keep existing values, or type new values to update.${NC}"
    echo ""
else
    echo -e "${GREEN}This script will create a .env file with your configuration.${NC}"
    echo -e "${GREEN}Press Enter to accept default values shown in [brackets].${NC}"
    echo ""
fi

# Function to read input with default (preserving existing values)
read_with_default() {
    local prompt="$1"
    local default="$2"
    local var_name="$3"
    local is_secret="${4:-false}"
    
    if [ "$is_secret" = "true" ]; then
        # For secrets, show masked default
        local display_default="$default"
        if [ ${#default} -gt 0 ] && [ "$ENV_EXISTS" = true ]; then
            display_default="********"
        fi
        read -s -p "$prompt [$display_default]: " value
        echo "" # New line after secret input
    else
        read -p "$prompt [$default]: " value
    fi
    
    if [ -z "$value" ]; then
        eval "$var_name=\"$default\""
    else
        eval "$var_name=\"$value\""
    fi
}

# InfluxDB Configuration
echo -e "${BLUE}--- InfluxDB Configuration ---${NC}"
echo ""

CURRENT_HOST=$(get_env_value "INFLUXDB_HOST" "192.168.1.10")
CURRENT_PORT=$(get_env_value "INFLUXDB_PORT" "8086")
CURRENT_DATABASE=$(get_env_value "INFLUXDB_DATABASE" "filamentbox")
CURRENT_USERNAME=$(get_env_value "INFLUXDB_USERNAME" "admin")
CURRENT_PASSWORD=$(get_env_value "INFLUXDB_PASSWORD" "changeme")

read_with_default "InfluxDB Host" "$CURRENT_HOST" INFLUXDB_HOST
read_with_default "InfluxDB Port" "$CURRENT_PORT" INFLUXDB_PORT
read_with_default "InfluxDB Database Name" "$CURRENT_DATABASE" INFLUXDB_DATABASE
read_with_default "InfluxDB Username" "$CURRENT_USERNAME" INFLUXDB_USERNAME
read_with_default "InfluxDB Password" "$CURRENT_PASSWORD" INFLUXDB_PASSWORD true

echo ""
echo -e "${BLUE}--- Data Collection Configuration ---${NC}"
echo ""

CURRENT_MEASUREMENT=$(get_env_value "DATA_COLLECTION_MEASUREMENT" "environment")
CURRENT_TAGS=$(get_env_value "DATA_COLLECTION_TAGS" "")

read_with_default "Measurement Name" "$CURRENT_MEASUREMENT" DATA_COLLECTION_MEASUREMENT
read_with_default "Add custom tags? (JSON format, e.g., {\"location\":\"workshop\"})" "$CURRENT_TAGS" DATA_COLLECTION_TAGS

echo ""
echo -e "${BLUE}--- Configuration Summary ---${NC}"
echo ""
echo "InfluxDB Host:     $INFLUXDB_HOST"
echo "InfluxDB Port:     $INFLUXDB_PORT"
echo "InfluxDB Database: $INFLUXDB_DATABASE"
echo "InfluxDB Username: $INFLUXDB_USERNAME"
echo "InfluxDB Password: ********"
echo "Measurement Name:  $DATA_COLLECTION_MEASUREMENT"
if [ -n "$DATA_COLLECTION_TAGS" ]; then
    echo "Custom Tags:       $DATA_COLLECTION_TAGS"
fi

echo ""
read -p "Save this configuration? [Y/n]: " confirm
if [[ "$confirm" =~ ^[Nn]$ ]]; then
    echo -e "${YELLOW}Setup cancelled. No changes made.${NC}"
    exit 0
fi

# Backup existing .env if it exists
if [ "$ENV_EXISTS" = true ]; then
    BACKUP_FILE="${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
    cp "$ENV_FILE" "$BACKUP_FILE"
    echo ""
    echo -e "${GREEN}Existing .env backed up to:${NC}"
    echo -e "${GREEN}$BACKUP_FILE${NC}"
fi

# Create .env file
echo ""
if [ "$ENV_EXISTS" = true ]; then
    echo -e "${GREEN}Updating .env file...${NC}"
else
    echo -e "${GREEN}Creating .env file...${NC}"
fi

cat > "$ENV_FILE" << EOF
# FilamentBox Environment Configuration
# Generated on: $(date)
# 
# This file contains sensitive configuration that overrides values in config.yaml
# DO NOT commit this file to version control!

# InfluxDB Connection
INFLUXDB_HOST=$INFLUXDB_HOST
INFLUXDB_PORT=$INFLUXDB_PORT
INFLUXDB_DATABASE=$INFLUXDB_DATABASE
INFLUXDB_USERNAME=$INFLUXDB_USERNAME
INFLUXDB_PASSWORD=$INFLUXDB_PASSWORD

# Data Collection
DATA_COLLECTION_MEASUREMENT=$DATA_COLLECTION_MEASUREMENT
EOF

# Add tags if provided
if [ -n "$DATA_COLLECTION_TAGS" ]; then
    echo "DATA_COLLECTION_TAGS=$DATA_COLLECTION_TAGS" >> "$ENV_FILE"
fi

# Set proper permissions
chmod 600 "$ENV_FILE"

echo ""
echo -e "${GREEN}========================================${NC}"
if [ "$ENV_EXISTS" = true ]; then
    echo -e "${GREEN}Configuration Updated!${NC}"
else
    echo -e "${GREEN}Configuration Complete!${NC}"
fi
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${GREEN}.env file saved at:${NC}"
echo -e "${GREEN}$ENV_FILE${NC}"
echo ""
echo -e "${YELLOW}Important Security Notes:${NC}"
echo -e "${YELLOW}1. The .env file contains sensitive credentials${NC}"
echo -e "${YELLOW}2. File permissions set to 600 (owner read/write only)${NC}"
echo -e "${YELLOW}3. DO NOT commit this file to version control${NC}"
echo -e "${YELLOW}4. Ensure .env is in your .gitignore${NC}"
if [ "$ENV_EXISTS" = true ]; then
    echo ""
    echo -e "${BLUE}A backup of your previous .env was created.${NC}"
fi
echo ""
