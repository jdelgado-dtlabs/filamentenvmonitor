# FSEM v2.0 - Major Features Summary

**Filament Storage Environmental Manager - Comprehensive Feature Overview**

This document provides a comprehensive overview of all major features added in version 2.0, intended for inclusion in CHANGELOG.md, README.md, and documentation.

## Version 2.0 Release Highlights

Version 2.0 represents a major architectural overhaul with focus on security, scalability, user experience, and real-time web capabilities.

---

## üéØ Major Features

### 1. **Modern React-Based Web UI**
**Status**: ‚úÖ Complete  
**Components**: 
- Progressive Web App (PWA) with offline support
- Responsive design for desktop, tablet, and mobile
- Component-based architecture using React + Vite
- Hot module replacement for development
- Production build optimization with code splitting

**Key Files**:
- `/webui/webui-react/` - Complete React application
- Modern component library (Cards, Controls, Configuration Editor)
- Custom hooks for data polling and state management

**User Benefits**:
- Install as native app on mobile/desktop
- Fast, responsive interface with modern UX
- Better performance than legacy HTML interface
- Consistent experience across all devices

---

### 2. **Server-Sent Events (SSE) for Real-Time Updates**
**Status**: ‚úÖ Complete  
**Implementation**: 
- `/api/stream` endpoint using Flask SSE
- EventSource API on client side
- Pushes updates every second with combined status (sensor, controls, database, threads)
- Automatic reconnection on connection loss

**Key Features**:
- Real-time sensor data updates (no polling needed)
- Live control state synchronization
- Thread status monitoring
- Database health monitoring
- Notification delivery via SSE

**Technical Details**:
```python
# Server: webui/webui_server.py
@app.route("/api/stream")
def stream_updates():
    # Generates SSE events with system status
```

```javascript
// Client: webui/webui-react/src/hooks/useServerEvents.js
const eventSource = new EventSource('/api/stream');
eventSource.onmessage = (event) => { /* handle updates */ };
```

---

### 3. **Comprehensive Notification System**
**Status**: ‚úÖ Complete  
**Architecture**: 
- **Backend Publisher** (`filamentbox/notification_publisher.py`)
  - Publish notifications from any thread
  - Thread-safe notification queue (50 message buffer)
  - Callback system for web delivery
  - Convenience methods: `notify_success()`, `notify_error()`, `notify_warning()`

- **API Endpoints**:
  - `GET /api/notifications` - Retrieve recent notifications
  - `DELETE /api/notifications` - Clear notification history
  - SSE stream includes real-time notification delivery

- **Browser Notifications** (`webui/webui-react/src/utils/notifications.js`)
  - OS-level desktop/mobile notifications
  - Permission request flow
  - LocalStorage persistence for preferences
  - Automatic fallback if not supported

- **In-App Notification Panel**
  - Sliding panel with notification history
  - Color-coded by type (success/error/warning/info)
  - Dismissible messages
  - Timestamp display

**Use Cases**:
- Thread restart/stop notifications
- Configuration update confirmations
- Database connection errors
- Sensor read failures
- Control state changes

---

### 4. **Master Thread Orchestrator**
**Status**: ‚úÖ Complete  
**Implementation**: `filamentbox/orchestrator.py`

**Features**:
- Centralized thread lifecycle management
- Eliminates file-based IPC (replaced with direct queue communication)
- Automatic thread registration and monitoring
- Graceful shutdown coordination
- Data distribution to control threads

**Managed Threads**:
- Sensor reading loop
- Database writer
- Heating control
- Humidity control
- Web UI server

**Benefits**:
- Simplified architecture (no temporary files)
- Better error recovery
- Coordinated restarts
- Unified monitoring
- Clean separation of concerns

---

### 5. **Hot-Reload Configuration Changes**
**Status**: ‚úÖ Complete  
**Implementation**: `filamentbox/config_watcher.py`

**Features**:
- Monitors config database for file modification time changes
- Automatic reload when configuration is updated
- Callback system for configuration-dependent components
- Key-specific and global change notifications
- Thread-safe callback execution

**How It Works**:
1. Background watcher thread checks database mtime every 2 seconds
2. On change detected, calls `reload_config()` to refresh in-memory cache
3. Compares old vs new values for registered keys
4. Notifies registered callbacks of changes
5. Threads can react to config changes without restart

**Supported Hot-Reload**:
- Database connection settings (reconnect on change)
- Control thresholds (heating/humidity)
- Data collection intervals
- Batch sizes
- Tag configurations
- Most configuration parameters (some may require restart)

**Example Usage**:
```python
from filamentbox.config_watcher import register_callback

def on_threshold_change(key: str, value: Any):
    logger.info(f"Temperature threshold changed to {value}")
    # Update control logic

register_callback("heating_control.min_temp_c", on_threshold_change)
```

---

### 6. **Encrypted Configuration with SQLCipher**
**Status**: ‚úÖ Complete  
**Implementation**: `filamentbox/config_db.py`

**Security Features**:
- 256-bit AES encryption for all configuration data
- Auto-generated 64-character encryption keys (384 bits entropy)
- Cryptographically secure key generation from `/dev/urandom`
- Key stored with 600 permissions (owner read/write only)
- No plain-text credentials in version control

**Key Management**:
1. **HashiCorp Vault** (recommended for production)
2. **Environment Variable** (`FILAMENTBOX_CONFIG_KEY`)
3. **Local File** (`.config_key`)
4. **Default Key** (dev/testing only)

**Migration Support**:
- Automatic migration from YAML + .env files
- Preserves all existing settings
- Timestamped backup of legacy configs
- One-time migration with legacy file removal

**Configuration Tool** (`scripts/config_tool.py`):
- Letter-based menu navigation (B/N/S/V/E/D/C/Q)
- Browse by section with hierarchical navigation
- Search by key name
- Menu selection for predefined values
- Special tag editor for key-value pairs
- Type-safe value editing with validation
- Sensitive value masking

---

### 7. **Database Abstraction Layer (Multi-Database Support)**
**Status**: ‚úÖ Complete  
**Implementation**: 
- `filamentbox/databases/` - Database adapter framework
- `filamentbox/database_writer.py` - Unified writer interface

**Supported Backends** (7 total):
1. **InfluxDB v1** - Traditional HTTP API (username/password)
2. **InfluxDB v2** - Modern API (token/bucket/org)
3. **InfluxDB v3** - Cloud/serverless (database/token)
4. **Prometheus** - Push gateway integration
5. **TimescaleDB** - PostgreSQL extension with hypertables
6. **VictoriaMetrics** - High-performance metrics database
7. **None** - Sensor-only mode (no database)

**Abstraction Features**:
- Unified `DatabaseAdapter` base class
- Backend-specific optimizations
- Common write interface
- Consistent error handling
- Factory pattern for adapter creation
- Easy switching between backends via configuration

**Benefits**:
- Flexibility in database choice
- Future-proof architecture
- Easy to add new database backends
- Consistent behavior across all backends
- Simplified testing with mock adapters

---

### 8. **Tag Management Support**
**Status**: ‚úÖ Complete  
**Features**:
- Universal tag support across all database backends
- Tag editor in configuration tool
- JSON/dict storage in encrypted config
- Database-specific tag handling:
  - **InfluxDB**: Native tag support in line protocol
  - **Prometheus**: Labels on all metrics
  - **TimescaleDB**: JSONB column for tags
  - **VictoriaMetrics**: Tags in query parameters

**Configuration**:
```python
# Example tag configuration
database.influxdb.tags = {
    "location": "filament_room",
    "sensor_id": "bme280_01",
    "device": "raspberry_pi_4"
}
```

**Use Cases**:
- Multi-sensor deployments
- Location tracking
- Device identification
- Custom metadata for queries and dashboards

---

### 9. **Thread Restart Controls in Web UI**
**Status**: ‚úÖ Complete  
**Implementation**:
- Shared state mechanism for cross-process communication
- REST API endpoints for thread control
- React components for thread management UI

**API Endpoints**:
- `GET /api/threads` - Get status of all threads
- `POST /api/threads/{name}/restart` - Restart specific thread
- `POST /api/threads/{name}/start` - Start stopped thread
- `POST /api/threads/{name}/stop` - Stop running thread

**Supported Thread Operations**:
- `sensor_reader` - Data collection loop
- `database_writer` - Database write thread
- `heating_control` - Temperature control
- `humidity_control` - Humidity management
- `webui` - Web server thread

**Benefits**:
- Remote troubleshooting
- No need for SSH access
- Graceful thread restarts
- No full service restart required
- Real-time status updates

---

### 10. **Dark Mode Theme Support**
**Status**: ‚úÖ Complete  
**Implementation**: `webui/webui-react/src/utils/theme.js`

**Features**:
- Three theme modes: Light, Dark, Auto
- Auto mode follows OS preference
- LocalStorage persistence
- Dynamic theme switching without page reload
- CSS custom properties for theming
- Smooth transitions between themes

**OS Integration**:
- Detects system color scheme preference
- Respects `prefers-color-scheme` media query
- Updates automatically when OS theme changes

**Theme Persistence**:
```javascript
// Theme stored in localStorage
const theme = getSavedTheme(); // 'light', 'dark', or 'auto'
setTheme('dark'); // Apply and persist
```

**CSS Variables**:
```css
/* theme.css */
:root {
  --bg-primary: #ffffff;
  --text-primary: #000000;
  /* ... */
}

[data-theme="dark"] {
  --bg-primary: #1a1a1a;
  --text-primary: #ffffff;
  /* ... */
}
```

---

## üîß Infrastructure Improvements

### Auto-Generated Service Files
- Dynamic systemd service generation during setup
- Automatic Vault environment variable embedding
- No manual service file editing required
- Portable installation support (works in any directory)

### Portable Installation
- Install in any directory: `/opt`, `/home`, `/srv`, etc.
- Auto-detection of installation path
- Auto-detection of user/group
- Dynamic service file generation with correct paths

### Enhanced Setup Script
- Vault availability check during setup
- Optional hvac library installation
- Interactive Vault server and authentication configuration
- Graceful fallback to local file storage
- Clear status messages for Vault vs local storage

---

## üìö Documentation Additions

### New Documentation Files
1. **docs/ENCRYPTION_KEY_SECURITY.md**
   - Key generation process
   - Storage options (Vault, file, env var)
   - Loading priority
   - Recovery procedures
   - Security best practices

2. **docs/VAULT_INTEGRATION.md**
   - Complete Vault setup guide
   - Token and AppRole authentication
   - Configuration examples
   - Troubleshooting

3. **docs/SERVICE_AUTO_GENERATION.md**
   - Service file generation process
   - Template system
   - Vault variable embedding
   - Portable installation details

4. **docs/configuration_tags.md**
   - Tag management guide
   - Database-specific tag handling
   - Examples for all backends

### Updated Documentation
- README.md - v2.0 features and encrypted configuration
- Installation guide - New setup workflow
- Security considerations - Encryption and Vault

---

## ‚ö†Ô∏è Breaking Changes

### Configuration System Overhaul
**Impact**: HIGH - Affects all users

**What Changed**:
- `config.yaml` **no longer supported**
- `.env` file **no longer supported**
- All configuration now in encrypted SQLCipher database (`config.db`)
- Different API for accessing configuration

**Migration Required**: YES

**Migration Path**:
```bash
# Option 1: Automatic (recommended)
sudo ./install/setup.sh

# Option 2: Manual
python scripts/migrate_config.py
```

**What Happens**:
1. Reads existing `config.yaml` and `.env`
2. Generates encryption key
3. Creates encrypted `config.db`
4. Imports all settings
5. Creates timestamped backup of legacy files
6. Removes legacy files (after backup)

**No Data Loss**: All settings preserved during migration

---

### Environment Variable Changes
**Impact**: MEDIUM - Affects manual deployments

**What Changed**:
- Individual credential variables **no longer used**
- Single `FILAMENTBOX_CONFIG_KEY` variable for encryption key
- New Vault-specific variables added

**Old (v1.x)**:
```bash
INFLUXDB_HOST=localhost
INFLUXDB_PORT=8086
INFLUXDB_DATABASE=filament_storage
INFLUXDB_USERNAME=admin
INFLUXDB_PASSWORD=secret123
```

**New (v2.0)**:
```bash
# Encryption key (if not using Vault or .config_key file)
FILAMENTBOX_CONFIG_KEY=auto-generated-64-char-key

# Optional Vault configuration
VAULT_ADDR=https://vault.example.com:8200
VAULT_TOKEN=s.your_token_here
# OR
VAULT_ROLE_ID=your_role_id
VAULT_SECRET_ID=your_secret_id
```

---

### Service File Changes
**Impact**: LOW - Handled automatically

**What Changed**:
- Service files now **auto-generated** during setup
- Manual modifications to service files **will be overwritten**
- Service files include Vault environment variables

**Migration**:
- Run `sudo ./install/setup.sh`
- Service files regenerated automatically
- Old service files backed up

**For Custom Modifications**:
- Use `install/setup.sh` template system
- Or modify after each setup (not recommended)

---

### Python API Changes (For Developers)
**Impact**: LOW - Only affects custom code using internal APIs

**Configuration Access**:
```python
# Old (v1.x)
import yaml
with open('config.yaml') as f:
    config = yaml.safe_load(f)
value = config['section']['key']

# New (v2.0)
from filamentbox.config import get
value = get('section.key')
```

**Hot-Reload Support**:
```python
# New in v2.0
from filamentbox.config_watcher import register_callback

def on_change(key: str, value: Any):
    print(f"Config changed: {key} = {value}")

register_callback('database.type', on_change)
```

---

## üìã Migration Checklist

### Pre-Migration (Backup)
- [ ] Backup current `config.yaml`
- [ ] Backup current `.env` file
- [ ] Export InfluxDB data (if needed)
- [ ] Note current service status

### Migration Steps
1. [ ] Pull latest code: `git pull origin v2.0-rc`
2. [ ] Run setup: `sudo ./install/setup.sh`
3. [ ] **Save encryption key displayed during setup** (critical!)
4. [ ] Verify configuration: `python scripts/config_tool.py`
5. [ ] Test services: `sudo systemctl status filamentbox.service`
6. [ ] Access web UI: `http://localhost:5000`

### Post-Migration Verification
- [ ] Sensor readings working
- [ ] Database writes successful
- [ ] Web UI accessible
- [ ] Controls functioning (heater/fan)
- [ ] Notifications appearing
- [ ] Thread restarts working

### For Vault Users (Optional)
1. [ ] Set up Vault server
2. [ ] Store encryption key in Vault
3. [ ] Configure Vault in setup script
4. [ ] Test key retrieval
5. [ ] Remove local `.config_key` file

---

## üîÑ Upgrade Path from v1.x

### Scenario 1: Fresh Installation (No Existing Data)
```bash
git clone https://github.com/jdelgado-dtlabs/filamentenvmonitor.git
cd filamentenvmonitor
git checkout v2.0-rc
sudo ./install/install.sh
```
- No migration needed
- Fresh encrypted configuration
- All v2.0 features available

### Scenario 2: Existing v1.x Installation (Keep Data)
```bash
cd /opt/filamentcontrol
git pull origin v2.0-rc
sudo ./install/setup.sh
```
- Automatic migration of existing config
- Settings preserved
- Legacy files backed up
- Encryption key generated
- Services regenerated

### Scenario 3: Custom Deployment (Docker/Manual)
1. Update code: `git pull origin v2.0-rc`
2. Run migration: `python scripts/migrate_config.py`
3. Save encryption key (displayed during migration)
4. Set environment variable: `export FILAMENTBOX_CONFIG_KEY="your-key"`
5. Update service files with new environment variables
6. Restart services

---

## üöÄ Performance Improvements

### Database Writer Optimizations
- Backend-specific batching strategies
- Reduced memory footprint
- Better error recovery
- Optimized connection pooling

### Configuration Access
- In-memory cache with instant lookups
- Lazy loading of config sections
- Reduced database queries
- ~10x faster configuration reads

### Web UI Performance
- React code splitting (smaller initial bundle)
- Service worker caching (offline support)
- Optimized re-renders with React.memo
- Debounced API calls

### Thread Management
- Direct queue communication (no file I/O)
- Reduced context switching
- Better CPU utilization
- Lower latency for control updates

---

## üîÆ Future Considerations

### Deprecated (Will Be Removed in v3.0)
- Legacy HTML web UI (`webui/index.html.legacy`)
- File-based IPC mechanisms
- YAML configuration support (already removed in v2.0)

### Planned Features
- Multi-sensor aggregation (multiple sensors in one instance)
- MQTT integration for remote monitoring
- Email/SMS alerting via notification system
- Authentication for web UI (OAuth2, basic auth)
- Historical data visualization in React UI
- Mobile app (React Native using same backend)
- Grafana dashboard templates
- Kubernetes deployment manifests

---

## üìä Statistics

### Code Changes (v1.x ‚Üí v2.0)
- **~125 commits** since December 2024
- **7 new database adapters** implemented
- **React application**: ~3000 lines of code
- **New modules**: 8 (orchestrator, config_watcher, notification_publisher, etc.)
- **Documentation**: 4 new comprehensive guides
- **Tests**: Expanded coverage for all new features

### Features Added
- ‚úÖ 10 major features
- ‚úÖ 7 database backends
- ‚úÖ React-based modern UI
- ‚úÖ Real-time SSE updates
- ‚úÖ Comprehensive notifications
- ‚úÖ Hot-reload configuration
- ‚úÖ Encrypted config database
- ‚úÖ Thread management via UI
- ‚úÖ Dark mode theme
- ‚úÖ Tag management

---

## üìû Support & Resources

### Getting Help
- **GitHub Issues**: https://github.com/jdelgado-dtlabs/filamentenvmonitor/issues
- **Documentation**: `/docs` folder in repository
- **Changelog**: `CHANGELOG.md` for detailed version history

### When Filing Issues
Include:
- Version: `v2.0-rc`
- OS and Python version
- Logs: `sudo journalctl -u filamentbox.service -n 100`
- Configuration (sanitized - remove credentials)
- Steps to reproduce

### Migration Issues
If migration fails:
1. Check `config_backup_*` folder for your original files
2. Run `python scripts/migrate_config.py` again
3. Verify `.config_key` file exists and has 600 permissions
4. Check logs: `sudo journalctl -u filamentbox.service`
5. Open GitHub issue with error details

---

## ‚úÖ Testing v2.0 Features

### Quick Test Checklist
```bash
# 1. Verify encrypted configuration
python scripts/config_tool.py
# Browse sections, verify all settings present

# 2. Test web UI
firefox http://localhost:5000
# Check sensor readings, controls, theme toggle

# 3. Test SSE real-time updates
# Open web UI, watch for live sensor updates
# Should update every 1-2 seconds without page refresh

# 4. Test notifications
# In web UI, click "Enable Browser Notifications"
# Restart a thread via UI
# Should see browser notification

# 5. Test hot-reload
python scripts/config_tool.py
# Change a threshold value
# Web UI should reflect change without restart

# 6. Test thread controls
# In web UI, click "Restart" on any thread
# Thread should restart without service restart
# Should see notification

# 7. Test dark mode
# Click theme toggle in top-right
# UI should switch to dark theme
# Refresh page - theme should persist

# 8. Test database abstraction
# Change database.type in config
# Restart service
# Should write to new database backend
```

---

This document provides a complete overview of v2.0 features for documentation purposes. Use the relevant sections to update CHANGELOG.md, README.md, and create new documentation as needed.
