<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Storage Environmental Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa; min-height: 100vh; padding: 20px; color: #2c3e50;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2rem; margin-bottom: 8px; color: #2c3e50; font-weight: 600; }
        header p { font-size: 0.95rem; color: #7f8c8d; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e1e8ed; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #ecf0f1; }
        .card-header h2 { font-size: 1.1rem; color: #2c3e50; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .reading { margin: 12px 0; }
        .reading-label { font-size: 0.85rem; color: #7f8c8d; margin-bottom: 4px; font-weight: 500; }
        .reading-value { font-size: 1.8rem; font-weight: 600; color: #2c3e50; }
        .reading-unit { font-size: 1rem; color: #95a5a6; margin-left: 4px; font-weight: 400; }
        .status-indicator { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 4px; font-weight: 500; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-on { background: #d4edda; color: #155724; }
        .status-off { background: #f8d7da; color: #721c24; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-on .status-dot { background: #28a745; }
        .status-off .status-dot { background: #dc3545; }
        .timestamp { font-size: 0.75rem; color: #95a5a6; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn:hover { opacity: 0.8; }
        .btn:active { opacity: 0.6; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .controls { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
        .controls .btn { flex: 1; min-width: 80px; justify-content: center; }
        .threshold-control { display: flex; align-items: center; gap: 12px; margin: 12px 0; padding: 12px; background: #f8f9fa; border-radius: 4px; }
        .threshold-label { font-size: 0.85rem; color: #7f8c8d; font-weight: 500; min-width: 80px; }
        .threshold-value { font-size: 1.2rem; font-weight: 600; color: #2c3e50; min-width: 60px; text-align: center; }
        .threshold-buttons { display: flex; gap: 4px; }
        .threshold-buttons .btn { width: 32px; height: 32px; padding: 0; justify-content: center; font-size: 1.1rem; font-weight: 600; }
        .config-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid #ecf0f1; display: none; }
        .config-section.active { display: block; }
        .config-item { margin: 12px 0; }
        .config-item label { display: block; font-size: 0.85rem; color: #7f8c8d; margin-bottom: 6px; font-weight: 500; }
        .config-item input, .config-item select { width: 100%; padding: 10px; border: 1px solid #dcdde1; border-radius: 4px; font-size: 0.9rem; font-family: inherit; transition: border-color 0.2s; }
        .config-item input:focus, .config-item select:focus { outline: none; border-color: #3498db; }
        .config-item input.error { border-color: #e74c3c; }
        .config-error { font-size: 0.75rem; color: #e74c3c; margin-top: 4px; display: none; }
        .config-error.active { display: block; }
        .config-help { font-size: 0.75rem; color: #95a5a6; margin-top: 4px; }
        .save-indicator { display: none; margin-top: 16px; }
        .save-indicator.active { display: block; }
        .message { padding: 12px 16px; border-radius: 4px; margin-bottom: 16px; font-size: 0.9rem; }
        .message-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .message-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .loading { text-align: center; color: #7f8c8d; font-size: 1.1rem; padding: 40px; }
        .stale-data { opacity: 0.5; }
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .controls { flex-direction: column; }
            .controls .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå°Ô∏è Filament Storage Environmental Manager</h1>
            <p>Real-time monitoring and control for 3D printer filament storage</p>
        </header>
        <div id="message-container"></div>
        <div id="dashboard" class="loading">Loading data...</div>
    </div>
    <script>
        const API_BASE = window.location.origin;
        let updateInterval;
        let configCache = {};
        let pendingChanges = new Set();
        let openConfigSections = new Set(); // Track which config sections are open

        function formatValue(val, decimals = 1) {
            return val != null && val !== undefined ? val.toFixed(decimals) : 'N/A';
        }

        function formatAge(seconds) {
            if (!seconds) return '';
            if (seconds < 60) return `${Math.floor(seconds)}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            return `${(seconds / 3600).toFixed(1)}h ago`;
        }

        function showMessage(msg, type = 'error') {
            document.getElementById('message-container').innerHTML = 
                `<div class="message message-${type}">${msg}</div>`;
            if (type === 'success') {
                setTimeout(() => {
                    document.getElementById('message-container').innerHTML = '';
                }, 3000);
            }
        }

        function clearMessage() {
            document.getElementById('message-container').innerHTML = '';
        }

        async function fetchData(endpoint) {
            const response = await fetch(`${API_BASE}/api/${endpoint}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }

        async function postData(endpoint, data) {
            const response = await fetch(`${API_BASE}/api/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || `HTTP error! status: ${response.status}`);
            return result;
        }

        async function putData(endpoint, data) {
            const response = await fetch(`${API_BASE}/api/${endpoint}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || `HTTP error! status: ${response.status}`);
            return result;
        }

        async function controlDevice(device, state) {
            await postData(`controls/${device}`, { state });
            await updateDashboard();
        }

        async function restartThread(threadName) {
            const result = await postData(`threads/${threadName}/restart`, {});
            showMessage(`‚úì ${result.message}`, 'success');
            await updateDashboard();
        }

        async function toggleConfigEditor(section) {
            const configDiv = document.getElementById(`config-${section}`);
            if (!configDiv) return;
            
            configDiv.classList.toggle('active');
            
            if (configDiv.classList.contains('active')) {
                openConfigSections.add(section);
                if (!configCache[section]) {
                    await loadConfigSection(section);
                }
            } else {
                openConfigSections.delete(section);
            }
        }

        async function loadConfigSection(section) {
            try {
                const config = await fetchData(`config/section/${section}`);
                configCache[section] = config;
                renderConfigSection(section, config);
            } catch (error) {
                showMessage(`Failed to load ${section} configuration: ${error.message}`);
            }
        }

        function renderConfigSection(section, config) {
            const configDiv = document.getElementById(`config-${section}`);
            if (!configDiv) return;

            let html = '';
            for (const [key, info] of Object.entries(config)) {
                const displayName = key.split('.').pop();
                const inputId = `input-${key.replace(/\./g, '-')}`;
                const errorId = `error-${key.replace(/\./g, '-')}`;
                
                let inputHtml = '';
                if (info.choices) {
                    inputHtml = `<select id="${inputId}" onchange="handleConfigChange('${key}', this.value, '${section}')">`;
                    for (const choice of info.choices) {
                        inputHtml += `<option value="${choice}" ${info.value === choice ? 'selected' : ''}>${choice}</option>`;
                    }
                    inputHtml += '</select>';
                } else if (info.type === 'bool') {
                    inputHtml = `<select id="${inputId}" onchange="handleConfigChange('${key}', this.value, '${section}')">
                        <option value="true" ${info.value === true ? 'selected' : ''}>True</option>
                        <option value="false" ${info.value === false ? 'selected' : ''}>False</option>
                    </select>`;
                } else {
                    const inputType = info.type === 'int' || info.type === 'float' ? 'number' : 'text';
                    const step = info.type === 'float' ? '0.1' : '1';
                    inputHtml = `<input type="${inputType}" step="${step}" id="${inputId}" 
                        value="${info.value !== null ? info.value : ''}" 
                        oninput="handleConfigChange('${key}', this.value, '${section}')"
                        title="${info.description}${info.example ? ' (e.g., ' + info.example + ')' : ''}">`;
                }

                html += `
                    <div class="config-item">
                        <label for="${inputId}" title="${info.description}">${displayName}</label>
                        ${inputHtml}
                        <div class="config-error" id="${errorId}"></div>
                        ${info.description ? `<div class="config-help">${info.description}${info.example ? ' (e.g., ' + info.example + ')' : ''}</div>` : ''}
                    </div>
                `;
            }

            html += `
                <div class="save-indicator" id="save-${section}">
                    <button class="btn btn-success" onclick="saveConfigSection('${section}')">üíæ Save Changes</button>
                    <button class="btn btn-secondary" onclick="cancelConfigChanges('${section}')">Cancel</button>
                </div>
            `;

            configDiv.innerHTML = html;
        }

        async function handleConfigChange(key, value, section) {
            const inputId = `input-${key.replace(/\./g, '-')}`;
            const errorId = `error-${key.replace(/\./g, '-')}`;
            const inputEl = document.getElementById(inputId);
            const errorEl = document.getElementById(errorId);

            pendingChanges.add(key);
            document.getElementById(`save-${section}`).classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/api/config/${key}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value, validate_only: true })
                });

                if (inputEl) {
                    if (response.ok) {
                        inputEl.classList.remove('error');
                        errorEl.classList.remove('active');
                    } else {
                        const error = await response.json();
                        inputEl.classList.add('error');
                        errorEl.textContent = error.error;
                        errorEl.classList.add('active');
                    }
                }
            } catch (error) {
                console.error('Validation error:', error);
            }
        }

        async function saveConfigSection(section) {
            try {
                const config = configCache[section];
                const errors = [];

                for (const [key, info] of Object.entries(config)) {
                    if (!pendingChanges.has(key)) continue;

                    const inputEl = document.getElementById(`input-${key.replace(/\./g, '-')}`);
                    if (!inputEl) continue;

                    let value = inputEl.value;
                    try {
                        if (info.type === 'bool') {
                            value = value === 'true';
                        } else if (info.type === 'int') {
                            value = parseInt(value);
                        } else if (info.type === 'float') {
                            value = parseFloat(value);
                        }

                        await putData(`config/${key}`, { value });
                    } catch (error) {
                        errors.push(`${key}: ${error.message}`);
                    }
                }

                if (errors.length > 0) {
                    showMessage(`Errors saving configuration: ${errors.join(', ')}`);
                } else {
                    showMessage('‚úì Configuration saved successfully', 'success');
                    pendingChanges.clear();
                    document.getElementById(`save-${section}`).classList.remove('active');
                    await updateDashboard();
                }
            } catch (error) {
                showMessage(`Failed to save configuration: ${error.message}`);
            }
        }

        function cancelConfigChanges(section) {
            pendingChanges.clear();
            document.getElementById(`save-${section}`).classList.remove('active');
            loadConfigSection(section);
        }

        async function adjustThreshold(device, threshold, delta) {
            try {
                const key = `${device}_control.${threshold}`;
                const current = await fetchData(`config/${key}`);
                const newValue = (parseFloat(current.value) + delta).toFixed(1);
                await putData(`config/${key}`, { value: parseFloat(newValue) });
                showMessage(`‚úì ${threshold} updated to ${newValue}`, 'success');
                await updateDashboard();
            } catch (error) {
                showMessage(`Failed to adjust threshold: ${error.message}`);
            }
        }

        function renderSensorCard(status, threads, staleClass) {
            const collectorThread = threads.data_collector || {};
            return `
                <div class="card ${staleClass}">
                    <div class="card-header">
                        <h2>üìä Sensor Readings</h2>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-primary" onclick="toggleConfigEditor('data_collection')">‚öôÔ∏è Config</button>
                            ${collectorThread.restartable ? '<button class="btn btn-sm btn-warning" onclick="restartThread(\'data_collector\')">üîÑ Restart</button>' : ''}
                        </div>
                    </div>
                    <div class="reading">
                        <div class="reading-label">Temperature</div>
                        <div class="reading-value">
                            ${formatValue(status.sensor.temperature_c, 2)}<span class="reading-unit">¬∞C</span>
                            <span style="color: #ccc; margin: 0 8px;">/</span>
                            ${formatValue(status.sensor.temperature_f, 2)}<span class="reading-unit">¬∞F</span>
                        </div>
                    </div>
                    <div class="reading">
                        <div class="reading-label">Humidity</div>
                        <div class="reading-value">
                            ${formatValue(status.sensor.humidity, 1)}<span class="reading-unit">%</span>
                        </div>
                    </div>
                    <div class="reading">
                        <div class="reading-label">Last Update</div>
                        <div class="timestamp">${formatAge(status.sensor.age)}</div>
                    </div>
                    <div class="config-section" id="config-data_collection"></div>
                </div>
            `;
        }

        function renderDatabaseCard(dbStatus, threads) {
            const dbThread = threads.database_writer || {};
            const dbType = dbStatus.type === 'none' ? 'None' : dbStatus.type.charAt(0).toUpperCase() + dbStatus.type.slice(1);
            
            return `
                <div class="card">
                    <div class="card-header">
                        <h2>üíæ Database</h2>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-primary" onclick="toggleConfigEditor('database')">‚öôÔ∏è Config</button>
                            ${dbThread.restartable ? '<button class="btn btn-sm btn-warning" onclick="restartThread(\'database_writer\')">üîÑ Restart</button>' : ''}
                        </div>
                    </div>
                    <div class="reading">
                        <div class="reading-label">Type</div>
                        <div class="reading-value" style="font-size: 1.1rem;">${dbType}</div>
                    </div>
                    <div class="reading">
                        <div class="reading-label">Status</div>
                        <span class="status-indicator ${dbStatus.storing_data ? 'status-on' : 'status-off'}">
                            <span class="status-dot"></span>
                            ${dbStatus.storing_data ? 'STORING' : 'INACTIVE'}
                        </span>
                    </div>
                    ${dbStatus.storing_data && dbStatus.last_write_time ? `
                        <div class="reading">
                            <div class="reading-label">Last Write</div>
                            <div class="reading-value" style="font-size: 0.9rem;">${formatAge(dbStatus.last_write_age)}</div>
                        </div>
                    ` : ''}
                    <div class="config-section" id="config-database"></div>
                </div>
            `;
        }

        function renderHeaterCard(status, heatingConfig) {
            const minTemp = heatingConfig['heating_control.min_temp_c']?.value || 0;
            const maxTemp = heatingConfig['heating_control.max_temp_c']?.value || 0;
            const enabled = heatingConfig['heating_control.enabled']?.value || false;
            
            return `
                <div class="card">
                    <div class="card-header">
                        <h2>üî• Heater</h2>
                        <div class="card-actions">
                            <span class="status-indicator ${status.controls.heater.on ? 'status-on' : 'status-off'}">
                                <span class="status-dot"></span>
                                ${status.controls.heater.on ? 'ON' : 'OFF'}
                            </span>
                            <button class="btn btn-sm btn-primary" onclick="toggleConfigEditor('heating_control')">‚öôÔ∏è Config</button>
                        </div>
                    </div>
                    <div class="threshold-control">
                        <span class="threshold-label">Turn ON at</span>
                        <div class="threshold-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('heating', 'max_temp_c', -0.5)">‚àí</button>
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('heating', 'max_temp_c', 0.5)">+</button>
                        </div>
                        <span class="threshold-value">${maxTemp}¬∞C</span>
                    </div>
                    <div class="threshold-control">
                        <span class="threshold-label">Turn OFF at</span>
                        <div class="threshold-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('heating', 'min_temp_c', -0.5)">‚àí</button>
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('heating', 'min_temp_c', 0.5)">+</button>
                        </div>
                        <span class="threshold-value">${minTemp}¬∞C</span>
                    </div>
                    ${enabled ? `
                        <div class="controls">
                            <button class="btn btn-success" onclick="controlDevice('heater', true)">Force ON</button>
                            <button class="btn btn-danger" onclick="controlDevice('heater', false)">Force OFF</button>
                            <button class="btn btn-secondary" onclick="controlDevice('heater', null)">Auto</button>
                        </div>
                    ` : '<p style="color: #95a5a6; text-align: center; padding: 20px; margin-top: 8px;">Heater control disabled in config</p>'}
                    <div class="config-section" id="config-heating_control"></div>
                </div>
            `;
        }

        function renderFanCard(status, humidityConfig) {
            const minHumidity = humidityConfig['humidity_control.min_humidity']?.value || 0;
            const maxHumidity = humidityConfig['humidity_control.max_humidity']?.value || 0;
            const enabled = humidityConfig['humidity_control.enabled']?.value || false;
            
            return `
                <div class="card">
                    <div class="card-header">
                        <h2>üí® Fan</h2>
                        <div class="card-actions">
                            <span class="status-indicator ${status.controls.fan.on ? 'status-on' : 'status-off'}">
                                <span class="status-dot"></span>
                                ${status.controls.fan.on ? 'ON' : 'OFF'}
                            </span>
                            <button class="btn btn-sm btn-primary" onclick="toggleConfigEditor('humidity_control')">‚öôÔ∏è Config</button>
                        </div>
                    </div>
                    <div class="threshold-control">
                        <span class="threshold-label">Turn ON at</span>
                        <div class="threshold-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('humidity', 'max_humidity', -1)">‚àí</button>
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('humidity', 'max_humidity', 1)">+</button>
                        </div>
                        <span class="threshold-value">${maxHumidity}%</span>
                    </div>
                    <div class="threshold-control">
                        <span class="threshold-label">Turn OFF at</span>
                        <div class="threshold-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('humidity', 'min_humidity', -1)">‚àí</button>
                            <button class="btn btn-sm btn-secondary" onclick="adjustThreshold('humidity', 'min_humidity', 1)">+</button>
                        </div>
                        <span class="threshold-value">${minHumidity}%</span>
                    </div>
                    ${enabled ? `
                        <div class="controls">
                            <button class="btn btn-success" onclick="controlDevice('fan', true)">Force ON</button>
                            <button class="btn btn-danger" onclick="controlDevice('fan', false)">Force OFF</button>
                            <button class="btn btn-secondary" onclick="controlDevice('fan', null)">Auto</button>
                        </div>
                    ` : '<p style="color: #95a5a6; text-align: center; padding: 20px; margin-top: 8px;">Fan control disabled in config</p>'}
                    <div class="config-section" id="config-humidity_control"></div>
                </div>
            `;
        }

        async function updateDashboard() {
            try {
                const [status, dbStatus, threads, heatingConfig, humidityConfig, sensorConfig] = await Promise.all([
                    fetchData('status'),
                    fetchData('database'),
                    fetchData('threads'),
                    fetchData('config/section/heating_control'),
                    fetchData('config/section/humidity_control'),
                    fetchData('config/section/data_collection')
                ]);

                clearMessage();

                const staleClass = status.sensor.age && status.sensor.age > 10 ? 'stale-data' : '';

                configCache.heating_control = heatingConfig;
                configCache.humidity_control = humidityConfig;
                configCache.sensor = sensorConfig;
                configCache.database = {};

                document.getElementById('dashboard').innerHTML = 
                    renderSensorCard(status, threads, staleClass) +
                    renderDatabaseCard(dbStatus, threads) +
                    renderHeaterCard(status, heatingConfig) +
                    renderFanCard(status, humidityConfig);

                // Restore open config sections after refresh
                for (const section of openConfigSections) {
                    const configDiv = document.getElementById(`config-${section}`);
                    if (configDiv) {
                        configDiv.classList.add('active');
                        // Re-render the config if it was loaded
                        if (configCache[section]) {
                            renderConfigSection(section, configCache[section]);
                        }
                    }
                }

            } catch (error) {
                showMessage(`Failed to fetch data: ${error.message}`);
                document.getElementById('dashboard').innerHTML = '';
            }
        }

        updateDashboard();
        updateInterval = setInterval(updateDashboard, 2000);
        window.addEventListener('beforeunload', () => {
            clearInterval(updateInterval);
        });
    </script>
</body>
</html>
